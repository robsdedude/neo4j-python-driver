[tox]
envlist = clean,py{37,38,39,310,311,312}-{unit,integration,performance}-{default,rust,purepy},report

[testenv:clean]
skip_install = true
deps = coverage[toml]
commands = coverage erase

[testenv]
passenv = TEST_NEO4J_*
deps =
    -r requirements-dev.txt
setenv =
    {unit,integration}: COVERAGE_FILE = {toxworkdir}/.coverage/.coverage.{envname}
    {default,purepy}: TEST_NEO4J_EXPECT_EXTERNAL_EXTENSIONS = 0
    rust: TEST_NEO4J_EXPECT_EXTERNAL_EXTENSIONS = 1
    purepy: TEST_NEO4J_EXPECT_OWN_EXTENSIONS = 0
warnargs = py{37,38,39,310,311,312}: -W error
commands =
    purepy: python -m pip install --force-reinstall --no-deps pkg_py/
    rust: python -m pip install --force-reinstall --no-deps pkg_rust/

    unit: pytest --cov --cov-append {[testenv]warnargs} -v {posargs} tests/unit
    integration: pytest --cov --cov-append {[testenv]warnargs} -v {posargs} tests/integration
    performance: pytest {[testenv]warnargs} --benchmark-autosave --benchmark-group-by=fullname -v {posargs} tests/performance

depends =
    {unit,integration,performance}: clean
    report: py{37,38,39,310,311,312}-{unit,integration}-{default,rust,purepy}

    # integration tests cannot run in parallel
    py38-integration-default: py37-integration-default
    py39-integration-default: py38-integration-default
    py310-integration-default: py39-integration-default
    py311-integration-default: py310-integration-default
    py312-integration-default: py311-integration-default

    py37-integration-rust: py312-integration-default
    py38-integration-rust: py37-integration-rust
    py39-integration-rust: py38-integration-rust
    py310-integration-rust: py39-integration-rust
    py311-integration-rust: py310-integration-rust
    py312-integration-rust: py311-integration-rust

    py37-integration-purepy: py312-integration-rust
    py38-integration-purepy: py37-integration-purepy
    py39-integration-purepy: py38-integration-purepy
    py310-integration-purepy: py39-integration-purepy
    py311-integration-purepy: py310-integration-purepy
    py312-integration-purepy: py311-integration-purepy

[testenv:report]
parallel_show_output = true
skip_install = true
deps = coverage[toml]
commands =
    coverage combine {toxworkdir}/.coverage
    coverage report
